<!DOCTYPE html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
  <head>
    <title>Pathology Report</title>
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg" />
    <link href="/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      /* Print Styling */
      @media print {
        .no-print {
          display: none;
        }

        body {
          background: white;
          -webkit-print-color-adjust: exact; /* For Chrome/Safari */
          print-color-adjust: exact; /* Standard property */
        }

        .report-box {
          border: none !important;
          box-shadow: none !important;
          margin: 0;
        }
      }

      .report-box {
        max-width: 800px;
        margin: 30px auto;
        background: white;
        padding: 40px;
        min-height: 1000px;
        /* A4 Height approx */
      }

      .header-line {
        border-bottom: 2px solid #0d6efd;
        margin-bottom: 20px;
      }
    </style>
  </head>

  <body class="bg-secondary">
    <div class="container">
      <!-- The A4 Page -->
      <div class="report-box shadow">
        <!-- 1. Header -->
        <div class="row align-items-center mb-4 header-line pb-3">
          <div class="col-8">
            <h1 class="text-primary fw-bold" th:text="${info.labName}"></h1>
            <p class="mb-0 text-muted" th:text="${info.tagLine}"></p>
          </div>
          <div class="col-4 text-end">
            <p class="mb-0">
              <strong>Ph:</strong> <span th:text="${info.phoneNumber}"></span>
            </p>
            <p class="mb-0" th:text="${info.city}"></p>
            <p class="mb-0 small text-muted" th:text="${info.email}"></p>
            <p class="mb-0 small text-muted" th:text="${info.website}"></p>
          </div>
        </div>

        <!-- 2. Patient Demographics -->
        <div class="row mb-4 small">
          <div class="col-md-6">
            <table class="table table-borderless table-sm">
              <tr>
                <td class="text-muted">Patient Name:</td>
                <td class="fw-bold" th:text="${order.patient.fullName}"></td>
              </tr>
              <tr>
                <td class="text-muted">Age / Gender:</td>
                <td
                  th:text="${order.patient.age} + ' Y / ' + ${order.patient.gender}"
                ></td>
              </tr>
              <tr>
                <td class="text-muted">MRN:</td>
                <td th:text="${order.patient.mrn}"></td>
              </tr>
            </table>
          </div>
          <div class="col-md-6">
            <table class="table table-borderless table-sm">
              <tr>
                <td class="text-muted">Date:</td>
                <td
                  th:text="${#temporals.format(order.orderDate, 'dd-MMM-yyyy HH:mm')}"
                ></td>
              </tr>
              <tr>
                <td class="text-muted">Ref By:</td>
                <td
                  th:text="${order.referringDoctor != null ? order.referringDoctor.name : 'Self'}"
                ></td>
              </tr>
              <tr>
                <td class="text-muted">Status:</td>
                <td class="fw-bold">Final Report</td>
              </tr>
            </table>
          </div>
        </div>

        <!-- 3. Results Table -->
        <h5 class="text-uppercase border-bottom mb-3">
          Laboratory Investigations
        </h5>

        <table class="table table-striped">
          <thead class="table-light">
            <tr>
              <th style="width: 35%">Test Name</th>
              <th style="width: 25%">Result</th>
              <th style="width: 15%">Unit</th>
              <th style="width: 25%">Reference Range</th>
              <th style="width: 20%">Verified By</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="res : ${order.results}">
              <!-- Test Name -->
              <td th:text="${res.testDefinition.testName}" class="fw-bold"></td>

              <!-- Result Value (Highlight RED if abnormal) -->
              <td>
                <span
                  th:text="${res.resultValue}"
                  th:class="${res.isAbnormal} ? 'fw-bold text-danger' : 'fw-bold text-dark'"
                >
                </span>
                <!-- Show H/L flag -->
                <span
                  th:if="${res.isAbnormal}"
                  class="badge bg-danger ms-2"
                  th:text="${res.remarks}"
                ></span>
              </td>

              <!-- Unit -->
              <td th:text="${res.testDefinition.unit}"></td>

              <!-- Range -->
              <td>
                <span
                  th:if="${res.testDefinition.minRange != null}"
                  class="small text-muted"
                >
                  <span th:text="${res.testDefinition.minRange}"></span> -
                  <span th:text="${res.testDefinition.maxRange}"></span>
                </span>
              </td>
              <td>
                <div th:if="${res.performedBy != null}">
                  <span
                    class="fw-bold small"
                    th:text="${res.performedBy}"
                  ></span
                  ><br />
                  <span
                    class="text-muted"
                    style="font-size: 0.7em"
                    th:text="${#temporals.format(res.performedAt, 'dd-MMM HH:mm')}"
                  >
                  </span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- 4. Footer -->
        <div class="mt-5 pt-5 text-center">
          <p class="text-muted small">Digitally verified</p>
          <div class="mt-4">
            <img
              th:src="'data:image/png;base64,' + ${qrImage}"
              alt="QR Code"
              width="100"
            />
          </div>
        </div>
      </div>

      <!-- Buttons -->
      <div class="text-center no-print mb-5 pb-5">
        <button onclick="window.print()" class="btn btn-primary btn-lg">
          ðŸ–¨ Print Report
        </button>
        <!-- If LAB TECH or ADMIN, show "Back to Lab" -->
        <a
          sec:authorize="hasAnyRole('LAB', 'ADMIN')"
          href="/lab/worklist"
          class="btn btn-dark btn-lg ms-2"
        >
          Back to Lab
        </a>

        <!-- If RECEPTIONIST or ADMIN, show "Back to Reception" -->
        <!-- Note: Admin sees both buttons because they have both roles/access -->
        <a
          sec:authorize="hasAnyRole('RECEPTION', 'ADMIN')"
          href="/reception/dashboard"
          class="btn btn-outline-dark btn-lg ms-2"
        >
          Back to Reception
        </a>
      </div>
    </div>
  </body>
</html>
